<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ========== Meta Tags ========== -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="NicVG">
    <meta name="description" content="Freddys Pizza, La Mejor Pizza Artesanal de Leon, Guanajuato.">
    <!-- ======== Page title ============ -->
    <title>Mi Cuenta - Freddys Pizza</title>
    <!--<< Favicon >>-->
    <link rel="shortcut icon" href="assets/img/favicon.png">
    
    <!--<< Incluir configuración PHP >>-->
    <?php include_once 'header-include.php'; ?>
    
    <!-- Google Sign in -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!--<< Bootstrap min.css >>-->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <!--<< All Min Css >>-->
    <link rel="stylesheet" href="assets/css/all.min.css">
    <!--<< Animate.css >>-->
    <link rel="stylesheet" href="assets/css/animate.css">
    <!--<< Magnific Popup.css >>-->
    <link rel="stylesheet" href="assets/css/magnific-popup.css">
    <!--<< MeanMenu.css >>-->
    <link rel="stylesheet" href="assets/css/meanmenu.css">
    <!--<< Swiper Bundle.css >>-->
    <link rel="stylesheet" href="assets/css/swiper-bundle.min.css">
    <!--<< Nice Select.css >>-->
    <link rel="stylesheet" href="assets/css/nice-select.css">
    <!--<< Main.css >>-->
    <link rel="stylesheet" href="assets/css/main.css">
    <!--<< jQuery >>-->
    <script src="assets/js/jquery-3.7.1.min.js"></script>
    <!--<< MeanMenu >>-->
    <script src="assets/js/jquery.meanmenu.min.js"></script>
    <!--<< Auth.js >>-->
    <script src="assets/js/auth.js"></script>
    <!--<< Main.js >>-->
    <script src="assets/js/main.js"></script>
    <!--<< Account.js >>-->
    <script src="assets/js/account.js"></script>
    
    <!-- Estilos adicionales para la página de cuenta -->
    <!-- Los estilos se han movido a assets/scss/_account.scss -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Iniciar la aplicación cuando la configuración esté cargada
            document.addEventListener('configLoaded', function() {
                console.log('Configuración cargada, inicializando aplicación My Account');
                
                // Verificar estado de autenticación
                if (typeof checkAuthStatus === 'function') {
                    checkAuthStatus();
                    
                    // Cargar datos del usuario si la función está disponible
                    if (typeof loadUserData === 'function') {
                        console.log('Intentando cargar datos del usuario...');
                        loadUserData();
                    } else {
                        console.error('loadUserData no está definida');
                    }
                }
            });
            
            // Si no se dispara el evento configLoaded en 2 segundos, intentar iniciar de todas formas
            setTimeout(function() {
                if (typeof window.config !== 'undefined') {
                    console.log('Inicialización por timeout en My Account');
                    document.dispatchEvent(new Event('configLoaded'));
                } else {
                    console.error('Config no está disponible después de esperar en My Account');
                }
            }, 2000);
        });
    </script>
</head>

<body class="dark-mood" style="background-color: #2b2b2b; color: #fff;">
    <!-- Preloader Start -->
    <div id="preloader" class="preloader">
        <div class="animation-preloader">
            <div class="spinner"></div>
            <div class="txt-loading">
                <span data-text-preloader="F" class="letters-loading">F</span>
                <span data-text-preloader="R" class="letters-loading">R</span>
                <span data-text-preloader="E" class="letters-loading">E</span>
                <span data-text-preloader="D" class="letters-loading">D</span>
                <span data-text-preloader="D" class="letters-loading">D</span>
                <span data-text-preloader="Y" class="letters-loading">Y</span>
                <span data-text-preloader="S" class="letters-loading">S</span>
            </div>
            <p class="text-center">Cargando</p>
        </div>
    </div>

    <!-- Back To Top Start -->
    <button id="back-top" class="back-to-top">
        <i class="fa-regular fa-arrow-up"></i>
    </button>

    <!-- Offcanvas Area Start -->
    <div class="fix-area">
        <div class="offcanvas__info">
            <div class="offcanvas__wrapper">
                <div class="offcanvas__content">
                    <div class="offcanvas__top mb-5 d-flex justify-content-between align-items-center">
                        <div class="offcanvas__logo">
                            <a href="https://freddys.com.mx">
                                <img src="assets/img/logo/logo.svg" alt="logo-img">
                            </a>
                        </div>
                        <div class="offcanvas__close">
                            <button>
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="offcanvas__custom-menu d-xl-none">
                        <a href="https://freddys.com.mx" class="offcanvas__menu-btn">Inicio</a>
                        <a href="my-account.html" class="offcanvas__menu-btn">Mi Cuenta</a>
                        <!-- Botón Logout para Móvil (inicialmente oculto por CSS) -->
                        <button onclick="logout()" class="theme-btn offcanvas__menu-btn offcanvas-logout-btn" style="display: none; width: 100%; margin-top: 10px;">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                        </button>
                    </div>
                    <div class="offcanvas__navigation">
                        <div class="mobile-menu fix mb-3"></div>
                    </div>
                    <p class="text d-none d-lg-block">
                        Somos Freddy's Pizza, una pizzería familiar con la mejor calidad artesanal, donde nuestra prioridad es ofrecer el mejor sabor al mejor precio.
                    </p>
                    <div class="offcanvas__contact">
                        <h4>Contact Info</h4>
                        <ul>
                            <li class="d-flex align-items-center">
                                <div class="offcanvas__contact-icon">
                                    <i class="fal fa-map-marker-alt"></i>
                                </div>
                                <div class="offcanvas__contact-text">
                                    <a target="_blank" href="#">Fray Daniel Mireles 2514, Leon, Guanajuato, Mexico</a>
                                </div>
                            </li>
                            <li class="d-flex align-items-center">
                                <div class="offcanvas__contact-icon mr-15">
                                    <i class="fal fa-envelope"></i>
                                </div>
                                <div class="offcanvas__contact-text">
                                    <a href="tel:+4775780426"><span>freddyspizzaoficial@gmail.com</span></a>
                                </div>
                            </li>
                            <li class="d-flex align-items-center">
                                <div class="offcanvas__contact-icon mr-15">
                                    <i class="fal fa-clock"></i>
                                </div>
                                <div class="offcanvas__contact-text">
                                    <a target="_blank" href="#">Martes a Viernes 2PM - 9PM <br> Sabado y Domingo 1PM a 11:50PM</a>
                                </div>
                            </li>
                            <li class="d-flex align-items-center">
                                <div class="offcanvas__contact-icon mr-15">
                                    <i class="far fa-phone"></i>
                                </div>
                                <div class="offcanvas__contact-text">
                                    <a href="tel:+11002345909">4775780426</a>
                                </div>
                            </li>
                        </ul>
                        <div class="header-button mt-4">
                            <a href="shop.html" class="theme-btn">
                                <span class="button-content-wrapper d-flex align-items-center justify-content-center">
                                    <span class="button-icon"><i class="fa-sharp fa-regular fa-cart-shopping bg-transparent text-white me-2"></i></span>
                                    <span class="button-text">ORDENE AHORA!</span>
                                </span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="offcanvas__overlay"></div>

    <!-- Header Section Start -->
    <header class="header-section-3 dark-mood" style="background-image: url('assets/img/bg/bannerBG3_1.jpg'); background-repeat: no-repeat; background-size: cover; background-position: center center;">
        <div class="overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, #010F1C 0%, rgba(1, 15, 28, 0.75) 100%); z-index: 0;"></div>
        <div class="container-fluid" style="position: relative; z-index: 1;">
            <div class="main-header-wrapper">
                <div class="main-header-items">
                    <div id="header-sticky" class="header-3">
                        <div class="mega-menu-wrapper">
                            <div class="header-main">
                                <div class="header-left">
                                    <div class="header__hamburger d-xl-block my-auto">
                                        <div class="sidebar__toggle">
                                            <i class="fas fa-bars"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="header-middle">
                                    <div class="mean__menu-wrapper">
                                        <div class="main-menu">
                                            <nav id="mobile-menu">
                                                <ul>
                                                    <li class="main-nav-item d-xl-block d-none">
                                                        <a href="https://freddys.com.mx">Inicio</a>
                                                    </li>
                                                    <li class="logo-item d-none d-xl-block">
                                                        <div class="logo-image">
                                                            <a href="https://freddys.com.mx"><img src="assets/img/logo/logo-light.png" alt="Freddy's Logo"></a>
                                                        </div>
                                                    </li>
                                                    <li class="main-nav-item d-xl-block d-none">
                                                        <a href="my-account.html">Mi Cuenta</a>
                                                    </li>
                                                </ul>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                                <div class="header-right d-flex justify-content-end align-items-center">
                                    <!-- Google Sign-In -->
                                    <div id="google-signin-container" class="google-signin-container">
                                        <button class="custom-google-btn" onclick="window.location.href='https://freddys.com.mx/auth/google_auth.php'">
                                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                                            <span>Acceder con Google</span>
                                        </button>
                                    </div>
                                    <!-- User Welcome Container -->
                                    <div id="user-welcome-container" class="user-welcome-container" style="display: none;">
                                        <span id="user-welcome-text">Bienvenido</span>
                                        <button onclick="logout()" class="logout-btn">
                                            <i class="fas fa-sign-out-alt"></i>
                                            Cerrar Sesión
                                        </button>
                                    </div>
                                    <!-- Carrito -->
                                    <div class="header__cart">
                                        <a href="#" id="cart-icon-link">
                                            <i class="fa-sharp fa-regular fa-cart-shopping"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Cart Panel -->
    <div class="cart-panel" id="cartPanel">
        <div class="cart-header">
            <h3>Tu Carrito</h3>
            <button class="cart-close-btn" id="cartCloseBtn">X</button>
        </div>
        <div class="cart-items" id="cartItems">
            <!-- Los ítems se añadirán dinámicamente con JavaScript -->
        </div>
        <div class="cart-total" id="cartTotal">Total: $0.00</div>
        <form class="cart-form mt-4">
            <div class="mb-3">
                <label for="customerName" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="customerName" required>
            </div>
            <div class="mb-3">
                <label for="customerAddress" class="form-label">Dirección</label>
                <input type="text" class="form-control" id="customerAddress" required>
                <button type="button" class="add-address-btn" id="addAddressBtn" style="display: none;">Añadir otra dirección</button>
                <input type="hidden" id="latitude">
                <input type="hidden" id="longitude">
            </div>
            <div class="mb-3">
                <label for="customerPhone" class="form-label">Teléfono</label>
                <input type="tel" class="form-control" id="customerPhone" required>
            </div>
            <div class="payment-options">
                <label for="paymentMethod" class="form-label">Método de Pago</label>
                <select class="payment-method-select" id="paymentMethod">
                    <option value="">Seleccionar método de pago</option>
                    <option value="paypal">PayPal</option>
                    <option value="mercadopago">Mercado Pago</option>
                </select>
            </div>
            <div id="paypal-button-container" class="mt-3" style="display: none;"></div>
            <div id="wallet_container" class="mt-3" style="display: none;"></div>
        </form>
    </div>

    <!-- Account Section Start -->
    <section class="account-section section-padding" style="background-color: #181818; color: #FFFFFF;">
        <div class="container" style="background-color: #181818; padding: 20px;;">
            <div class="row">
                <div class="col-12">
                    <!-- Not Logged In State -->
                    <div id="notLoggedIn" class="account-not-logged text-center" style="background-color: #2b2b2b; padding: 20px; border-radius: 10px; border: 2px solid #02142A;">
                        <div class="account-not-logged-content">
                            <i class="fas fa-user-lock mb-4" style="font-size: 4rem; color: #02142A;"></i>
                            <h2 class="mb-3" style="color: #FFFFFF;">Acceso Requerido</h2>
                            <p class="mb-4" style="color: #CCCCCC;">Para acceder a tu cuenta y ver tu historial de pedidos, direcciones y telefonos, por favor inicia sesion con Google.</p>
                            <button class="custom-google-btn" onclick="window.location.href='https://freddys.com.mx/auth/google_auth.php'" style="background-color: #02142A; color: #fff; padding: 10px 20px; border: 2px solid #02142A; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; margin: 0 auto; width: fit-content;">
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="margin-right: 10px; width: 20px;">
                                <span>Iniciar Sesión con Google</span>
                            </button>
                        </div>
                    </div>

                    <!-- Logged In State -->
                    <div id="loggedIn" class="account-content" style="display: none;">
                        <div class="row">
                            <!-- Sidebar Navigation -->
                            <div class="col-lg-3">
                                <div class="account-sidebar">
                                    <div class="account-user-info mb-4">
                                        <div class="user-avatar">
                                            <img id="userAvatar" src="" alt="User Avatar">
                                        </div>
                                        <h3 id="userName" class="mt-3"></h3>
                                        <p id="userEmail"></p>
                                    </div>
                                    <ul class="account-menu">
                                        <li class="active" data-tab="orders">
                                            <a href="#"><i class="fas fa-shopping-bag"></i> Mis Pedidos</a>
                                        </li>
                                        <li data-tab="addresses">
                                            <a href="#"><i class="fas fa-map-marker-alt"></i> Mis Direcciones</a>
                                        </li>
                                        <li data-tab="phones">
                                            <a href="#"><i class="fas fa-phone"></i> Mis Teléfonos</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Main Content -->
                            <div class="col-lg-9">
                                <!-- Orders Tab -->
                                <div class="account-tab-content active" id="orders-tab">
                                    <div class="account-tab-header">
                                        <h2>Mis Pedidos</h2>
                                        <div class="order-filters">
                                            <select class="form-select" id="orderFilter">
                                                <option value="all">Todos los pedidos</option>
                                                <option value="pending">Pendientes</option>
                                                <option value="completed">Completados</option>
                                                <option value="cancelled">Cancelados</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="orders-table">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>ID Pedido</th>
                                                    <th>Fecha</th>
                                                    <th>Total</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ordersList">
                                                <!-- Orders will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Contenedor para detalles de pedido -->
                                    <div id="orderDetails" class="order-details" style="display: none;">
                                        <div class="order-details-header">
                                            <h3>Detalles del Pedido #<span id="orderDetailId"></span></h3>
                                            <button class="order-details-close" onclick="hideOrderDetails()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div class="order-info">
                                            <p><strong>Fecha:</strong> <span id="orderDetailDate"></span></p>
                                            <p><strong>Estado:</strong> <span id="orderDetailStatus"></span></p>
                                            <p><strong>Dirección de entrega:</strong> <span id="orderDetailAddress"></span></p>
                                        </div>
                                        <div class="order-items" id="orderDetailItems">
                                            <!-- Items will be populated here -->
                                        </div>
                                        <div class="order-total">
                                            <strong>Total:</strong> $<span id="orderDetailTotal"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Addresses Tab -->
                                <div class="account-tab-content" id="addresses-tab">
                                    <div class="account-tab-header">
                                        <h2>Mis Direcciones</h2>
                                        <button class="theme-btn" id="addAddressBtn">
                                            <i class="fas fa-plus"></i> Añadir Dirección
                                        </button>
                                    </div>
                                    <div class="addresses-grid row" id="addressesList">
                                        <!-- Las direcciones se cargarán dinámicamente -->
                                    </div>
                                    
                                    <!-- Contenedor para el formulario de direcciones -->
                                    <div id="address-form-container" class="account-form" style="display: none;">
                                        <!-- El formulario se cargará dinámicamente -->
                                    </div>
                                </div>

                                <!-- Phones Tab -->
                                <div class="account-tab-content" id="phones-tab">
                                    <div class="account-tab-header">
                                        <h2>Mis Teléfonos</h2>
                                        <button class="theme-btn" id="addPhoneBtn">
                                            <i class="fas fa-plus"></i> Añadir Teléfono
                                        </button>
                                    </div>
                                    <div class="phones-list row" id="phonesList">
                                        <!-- Los teléfonos se cargarán dinámicamente -->
                                    </div>
                                    
                                    <!-- Contenedor para el formulario de teléfonos -->
                                    <div id="phone-form-container" class="account-form" style="display: none;">
                                        <!-- El formulario se cargará dinámicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer Section -->
    <footer class="footer-section bg-title fix">
        <div class="footer-bottom">
            <div class="container">
                <div class="footer-wrapper d-flex align-items-center justify-content-between">
                    <p class="wow fadeInLeft" data-wow-delay=".3s">
                        © Gracias por Comprar en <a href="https://freddys.com.mx">Freddy's Pizza</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- All JS Plugins -->
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/jquery.waypoints.js"></script>
    <script src="assets/js/jquery.counterup.min.js"></script>
    <script src="assets/js/viewport.jquery.js"></script>
    <script src="assets/js/magnific-popup.min.js"></script>
    <script src="assets/js/tilt.min.js"></script>
    <script src="assets/js/swiper-bundle.min.js"></script>
    <script src="assets/js/wow.min.js"></script>
    <script src="assets/js/nice-select.min.js"></script>
    <!-- Custom Account JS -->
    <script src="assets/js/account.js"></script>
    
    <!-- Script Principal y de Carga Dinámica -->
    <script>
        // Fallback para initMap si Google Maps no carga
        window.initMap = window.initMap || function() {
            console.log('[Account Page] Inicializador Map fallback ejecutado');
        };

        // Inicializar carrito (igual que en index)
        if (typeof cart === 'undefined') {
            let cart = [];
            try {
                const savedCart = localStorage.getItem('cart');
                if (savedCart) {
                    cart = JSON.parse(savedCart);
                }
            } catch (error) {
                console.error('[Account Page] Error al cargar el carrito:', error);
                cart = [];
            }
        }

        // Listener para cargar SDKs cuando la config esté lista
        document.addEventListener('configLoaded', function() {
            console.log('[Account Page] Configuración cargada, inicializando SDKs...');
            
            // Cargar PayPal SDK
            if (window.config && window.config.PAYPAL_CLIENT_ID && !document.getElementById('paypal-script')) {
                console.log('[Account Page] Cargando SDK de PayPal...');
                const paypalScript = document.createElement('script');
                paypalScript.id = 'paypal-script';
                paypalScript.defer = true;
                paypalScript.src = `https://www.paypal.com/sdk/js?client-id=${window.config.PAYPAL_CLIENT_ID}&currency=MXN`;
                document.head.appendChild(paypalScript);
            }
            
            // Cargar Google Maps API
            if (window.config && window.config.GOOGLE_MAPS_API_KEY && !document.getElementById('maps-script')) {
                 console.log('[Account Page] Cargando API de Google Maps...');
                const mapsScript = document.createElement('script');
                mapsScript.id = 'maps-script';
                mapsScript.async = true;
                mapsScript.defer = true;
                mapsScript.src = `https://maps.googleapis.com/maps/api/js?key=${window.config.GOOGLE_MAPS_API_KEY}&libraries=places&callback=initMap`;
                window.initMap = initMap; // Asegurar que esté definida globalmente
                document.head.appendChild(mapsScript);
            }

            // Cargar Mercado Pago SDK
            if (window.config && window.config.MP_PUBLIC_KEY && !document.getElementById('mercadopago-sdk-script')) {
                console.log('[Account Page] Cargando SDK de Mercado Pago...');
                const mpScript = document.createElement('script');
                mpScript.id = 'mercadopago-sdk-script'; 
                mpScript.src = 'https://sdk.mercadopago.com/js/v2';
                mpScript.async = true;
                mpScript.onload = () => {
                    console.log('[Account Page] SDK de Mercado Pago cargado dinámicamente.');
                    if (typeof initializeMercadoPagoSDK === 'function' && window.mpInstance === null) {
                        initializeMercadoPagoSDK();
                    }
                };
                mpScript.onerror = () => {
                     console.error('[Account Page] Error al cargar SDK de Mercado Pago.');
                };
                document.head.appendChild(mpScript);
            }
            
            // Verificar Auth Status (si es necesario en esta página también)
            if (typeof checkAuthStatus === 'function') {
                checkAuthStatus();
                // setInterval(checkAuthStatus, 300000); // Considera si necesitas el intervalo aquí
            }
        });

        // Timeout fallback (igual que en index)
        setTimeout(function() {
            if (typeof window.config === 'undefined') {
                 console.error('[Account Page] Config no está disponible después de esperar');
            } else if (!window.configLoaded) { // Verificar si ya se disparó
                 console.log('[Account Page] Inicialización por timeout');
                 document.dispatchEvent(new Event('configLoaded'));
            }
        }, 2000);

        // Función de inicialización de Google Maps (Callback)
        function initMap() {
            console.log('[Account Page] initMap ejecutado.');
            if (typeof google !== 'undefined' && google.maps !== 'undefined') {
                console.log('[Account Page] Google Maps API cargada correctamente');
                
                // Intentar inicializar autocompletado si la función existe (de main.js)
                if (typeof initGoogleMapsAutocomplete === 'function') {
                    console.log('[Account Page] Llamando a initGoogleMapsAutocomplete desde initMap...');
                    initGoogleMapsAutocomplete(); 
                }

                // Intentar inicializar el autocompletado específico de esta página
                if (typeof initAutocomplete === 'function') {
                    console.log('[Account Page] Llamando a initAutocomplete específico de la página...');
                    initAutocomplete();
                }                
                
                // Inicializar mapa si existe el elemento #map en esta página
                const mapElement = document.getElementById('map'); 
                if (mapElement) {
                    try {
                        const map = new google.maps.Map(mapElement, {
                            center: { lat: 21.1213, lng: -101.6741 },
                            zoom: 12
                        });
                        console.log('[Account Page] Mapa inicializado en #map.');
                    } catch(mapError) {
                        console.error('[Account Page] Error al inicializar el mapa en #map:', mapError);
                    }
                }

            } else {
                console.error('[Account Page] Google Maps API no se cargó correctamente');
            }
        }
        window.initMap = initMap; // Asegurar que sea global


        // Inicializar eventos específicos de la página de cuenta (dentro de DOMContentLoaded)
        document.addEventListener('DOMContentLoaded', function() {
            // Listener para el carrito (si existe el icono en esta página)
            const cartIcon = document.getElementById('cartIcon'); // Asumiendo que tiene este ID
            const cartPanel = document.getElementById('cartPanel');
            const cartCloseBtn = document.getElementById('cartCloseBtn');

            if (cartIcon && cartPanel && cartCloseBtn) {
                cartIcon.addEventListener('click', function(e) {
                    e.preventDefault();
                    cartPanel.classList.add('open');
                    cartPanel.style.right = '0'; 
                    if(typeof updateCartDisplay === 'function') updateCartDisplay();
                });

                cartCloseBtn.addEventListener('click', function() {
                    cartPanel.classList.remove('open');
                    cartPanel.style.right = '-100%';
                });
                
                // Listener de clic fuera (igual que en main.js, si el carrito está aquí)
                 $(document).on("click.cartAccount", function(e) {
                    const $target = $(e.target);
                    if (
                        !$target.closest(cartPanel).length &&
                        !$target.closest(cartIcon).length &&
                        cartPanel.classList.contains("open") 
                    ) {
                        cartPanel.classList.remove('open');
                        cartPanel.style.right = '-100%';
                    }
                });
                 $(cartPanel).on("click.cartPanelAccount", function(e) { e.stopPropagation(); });
            }

            // Inicializar Google Sign-In (si el contenedor existe)
            const googleSignInContainer = document.getElementById('google-signin-container');
            /* --- COMENTAR ESTE BLOQUE PARA EVITAR CONFLICTOS ---
            if (googleSignInContainer && typeof google !== 'undefined' && google.accounts)
            {
                console.log('[Account Page] Configurando Google Sign-In...')
                 if (window.config && window.config.GOOGLE_CLIENT_ID) {
                    try {
                        google.accounts.id.initialize({
                            client_id: window.config.GOOGLE_CLIENT_ID,
                            callback: handleCredentialResponse // Usar la función definida abajo
                        });
                        google.accounts.id.renderButton(
                            googleSignInContainer,
                            { theme: 'outline', size: 'large', text: 'signin_with' } 
                        );
                         console.log('[Account Page] Botón Google Sign-In renderizado.')
                    } catch (signInError) {
                         console.error('[Account Page] Error inicializando Google Sign-In:', signInError);
                    }
                } else {
                    console.error('[Account Page] GOOGLE_CLIENT_ID no está configurado para Sign-In.');
                }
            } else if (googleSignInContainer) {
                 console.warn('[Account Page] Google Accounts SDK no listo para Sign-In.');
            }
            */ // --- FIN DEL BLOQUE COMENTADO ---

            // Llamar a la inicialización de Autocomplete específica de la página AHORA
            // ya que depende de elementos que están listos en DOMContentLoaded
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                 console.log('[Account Page] Google Maps lista en DOMContentLoaded, llamando initAutocomplete.');
                 initAutocomplete(); // La función definida más abajo
            } else {
                console.log('[Account Page] Google Maps no lista en DOMContentLoaded, esperando a initMap para initAutocomplete.');
                // initMap se encargará de llamarla cuando esté lista
            }
        });

        // Función callback para Google Sign-In (si se usa)
        function handleCredentialResponse(response) {
            console.log("[Account Page] ID Token recibido: " + response.credential);
            fetch('/auth/google_auth.php', { // Asegúrate que la ruta sea correcta
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ credential: response.credential })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('[Account Page] Inicio de sesión exitoso vía callback.');
                    if(typeof checkAuthStatus === 'function') checkAuthStatus(); // Actualizar UI
                    // Podrías redirigir o actualizar partes de la página aquí
                } else {
                    console.error('[Account Page] Error en el inicio de sesión backend:', data.message);
                    alert('Error al iniciar sesión.'); // O mostrar un mensaje más amigable
                }
            })
            .catch(error => {
                console.error('[Account Page] Error al procesar la autenticación:', error);
                alert('Error de comunicación al iniciar sesión.');
            });
        }

        // Función para inicializar el autocompletado específico de esta página
        // (Asumiendo que tienes campos como #customerAddress, #latitude, etc. aquí también)
        function initAutocomplete() {
             console.log('[Account Page] Ejecutando initAutocomplete específico...');
             const addressInput = document.getElementById('address_line'); // <<< ID DEL CAMPO DE DIRECCIÓN EN ESTA PÁGINA
             const latInput = document.getElementById('latitude');
             const lngInput = document.getElementById('longitude');
             // Añade otros campos si los tienes: cityInput, stateInput, zipInput

            if (addressInput && typeof google !== 'undefined' && google.maps && google.maps.places) {
                 console.log('[Account Page] Inicializando Places Autocomplete para #address_line');
                 try {
                    const autocomplete = new google.maps.places.Autocomplete(addressInput, {
                        types: ['address'],
                        componentRestrictions: { country: 'mx' }
                    });

                    autocomplete.addListener('place_changed', function() {
                        const place = autocomplete.getPlace();
                         console.log('[Account Page] Place selected:', place);
                        if (!place.geometry) {
                            console.warn("[Account Page] Autocomplete: No geometry found for place: ", place.name);
                            return;
                        }

                        // Actualizar campos (ajusta los IDs si son diferentes aquí)
                        if(latInput) latInput.value = place.geometry.location.lat();
                        if(lngInput) lngInput.value = place.geometry.location.lng();
                        
                        // Extraer componentes (ejemplo)
                        let components = {};
                        for (const component of place.address_components) {
                            const type = component.types[0];
                            components[type] = component.long_name;
                        }
                        console.log('[Account Page] Address components:', components);
                        // document.getElementById('city').value = components.locality || '';
                        // document.getElementById('state').value = components.administrative_area_level_1 || '';
                        // document.getElementById('zip').value = components.postal_code || '';
                        // ... etc.
                    });
                 } catch (autoCompError) {
                     console.error('[Account Page] Error inicializando Places Autocomplete:', autoCompError);
                 }
            } else if (addressInput) {
                 console.warn('[Account Page] Google Maps Places no listo para Autocomplete.');
            } else {
                console.log('[Account Page] Campo #address_line no encontrado para Autocomplete.');
            }
        }

        // Inicializar el componente PlaceAutocompleteElement
        function initPlaceAutocomplete() {
            const placeAutocomplete = document.getElementById('address_line');
            if (placeAutocomplete) {
                placeAutocomplete.addEventListener('gmp-place-changed', function() {
                    const place = placeAutocomplete.place;
                    if (!place) return;

                    // Extraer componentes de la dirección
                    let components = {};
                    for (const component of place.address_components) {
                        const type = component.types[0];
                        components[type] = component.long_name;
                    }

                    // Actualizar campos del formulario
                    document.getElementById('city').value = components.locality || '';
                    document.getElementById('state').value = components.administrative_area_level_1 || '';
                    document.getElementById('zip_code').value = components.postal_code || '';
                    document.getElementById('country').value = components.country || '';
                });
            }
        }

        // Llamar a la inicialización cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initPlaceAutocomplete);
    </script>
</body>
</html>
